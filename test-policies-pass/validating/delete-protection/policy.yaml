apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingAdmissionPolicy
metadata:
  name: delete-protection
spec:
  failurePolicy: Fail
  matchConstraints:
    resourceRules:
    - apiGroups: [""]
      apiVersions: ["v1"]
      operations: ["DELETE"]
      resources: ["namespaces", "persistentvolumes"]
  validations:
  - expression: |
      !has(oldObject.metadata.labels) ||
      !has(oldObject.metadata.labels.protect) ||
      oldObject.metadata.labels.protect != 'true'
    message: "Cannot delete protected resources. Remove 'protect: true' label first."
    reason: Forbidden

